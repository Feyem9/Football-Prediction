# =============================================================================
# PRONOSCORE - DÃ©ploiement Backend vers Render
# =============================================================================
# DÃ©clenchÃ© automatiquement lors d'un merge sur main ou production
# =============================================================================

name: ğŸš€ Deploy Backend

on:
  push:
    branches: [main, production]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch: # Permet le dÃ©clenchement manuel

env:
  RENDER_SERVICE_NAME: football-prediction

jobs:
  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref == 'refs/heads/production' && 'production' || 'staging' }}
      url: https://football-prediction-mbil.onrender.com

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/production" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "ğŸš€ Deploying to PRODUCTION"
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "ğŸ§ª Deploying to STAGING"
          fi

      - name: ğŸš€ Trigger Render Deploy
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "âš ï¸ RENDER_DEPLOY_HOOK_URL not set, skipping deployment"
            echo "ğŸ“ To enable auto-deploy, add RENDER_DEPLOY_HOOK_URL secret"
            exit 0
          fi

          echo "ğŸš€ Triggering Render deployment..."
          response=$(curl -s -X POST "$RENDER_DEPLOY_HOOK")
          echo "Response: $response"
          echo "âœ… Deploy triggered successfully!"

      - name: â³ Wait for deployment
        run: |
          echo "â³ Waiting 60 seconds for deployment to complete..."
          sleep 60

      - name: ğŸ” Health check
        run: |
          echo "ğŸ” Running health check..."
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://football-prediction-mbil.onrender.com/ || echo "000")
            if [ "$response" == "200" ]; then
              echo "âœ… Health check passed! (HTTP $response)"
              exit 0
            fi
            echo "â³ Attempt $i: HTTP $response - Retrying in 30s..."
            sleep 30
          done
          echo "âŒ Health check failed after 5 attempts"
          exit 1

      - name: ğŸ“¢ Notify success
        if: success()
        run: |
          echo "ğŸ‰ Backend deployed successfully!"
          echo "ğŸŒ URL: https://football-prediction-mbil.onrender.com"
          echo "ğŸ“… Deployed at: $(date)"
          echo "ğŸ”– Commit: ${{ github.sha }}"

      - name: ğŸ“¢ Notify failure
        if: failure()
        run: |
          echo "âŒ Backend deployment failed!"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "ğŸ“ Check Render dashboard for details"
